<!DOCTYPE html>
<html>
<head>
    <title>Spreadsheet</title>
    <style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background-color: #f7f7f7;
}

h2 { text-align: center; }

.top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

/* Sheet container behaves like a table with lines only */
.sheet-container {
    display: grid;
    grid-template-columns: 2fr 3fr 3fr; /* Time ~66%, Ads & Status full */
    border-collapse: collapse;
    width: 100%;
}

/* Cells: only borders, no separate boxes */
.sheet-cell {
    border: 1px solid #ccc; /* thin border lines */
}

/* Textarea style */
.sheet-cell textarea {
    width: 100%;
    min-height: 40px;
    border: none;          
    padding: 5px;
    box-sizing: border-box;
    font-size: 14px;
    resize: none;
    overflow: hidden;
    white-space: pre-wrap;
    word-wrap: break-word;
    background-color: transparent;
}

/* Focus highlight for textareas */
.sheet-cell textarea:focus {
    outline: 2px solid #007BFF;
    background-color: #eef5ff;
}

/* Header row style for both admin and employee */
.sheet-cell.header textarea,
.sheet-cell.header .read-only {
    font-weight: bold;
    background-color: #d9d9d9;
    cursor: default;
    text-align: center;
}

/* Employee read-only cells */
.read-only {
    text-align: left;
    min-height: 40px;
    line-height: 1.4em;
    background-color: transparent;
    white-space: pre-wrap;
    word-wrap: break-word;
}
</style>
</head>
<body>

<div class="top-bar">
    <h2>Spreadsheet ({{ role }})</h2>
    <a href="/logout">Logout</a>
</div>

{% if role != 'admin' %}
<p><em>You are in read-only mode</em></p>
{% endif %}

<div class="sheet-container" id="sheet-container">
    {% for r in range(sheet|length) %}
        {% for c in range(sheet[r]|length) %}
        <div class="sheet-cell {% if r == 0 %}header{% endif %}">
            {% if role == 'admin' %}
                <textarea data-row="{{ r }}" data-col="{{ c }}"
                          {% if r == 0 %}readonly{% endif %}>{{ sheet[r][c] }}</textarea>
            {% else %}
                <div class="read-only {% if r == 0 %}header{% endif %}">{{ sheet[r][c] }}</div>
            {% endif %}
        </div>
        {% endfor %}
    {% endfor %}
</div>

<script>
// Save a cell value to backend
function saveCell(textarea) {
    const row = parseInt(textarea.dataset.row);
    const col = parseInt(textarea.dataset.col);

    if (textarea.hasAttribute("readonly")) return;

    fetch("/update_cell", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `row=${row}&col=${col}&value=${encodeURIComponent(textarea.value)}`
    }).catch(err => console.error(err));

    autoGrow(textarea); // Adjust height after save
}

// Auto-grow function for textarea
function autoGrow(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
}

// Dynamically add an empty row at the bottom
function addEmptyRow(rowIndex) {
    const sheetContainer = document.querySelector(".sheet-container");
    for (let c = 0; c < 3; c++) {
        const newDiv = document.createElement("div");
        newDiv.className = "sheet-cell";

        const newTextarea = document.createElement("textarea");
        newTextarea.dataset.row = rowIndex;
        newTextarea.dataset.col = c;
        newTextarea.value = "";

        // Attach handlers
        newTextarea.addEventListener("blur", function() { saveCell(this); });
        newTextarea.addEventListener("input", function() { autoGrow(this); });
        newTextarea.addEventListener("keydown", function(e) {
            if (e.key === "Enter") {
                e.preventDefault();
                saveCell(this);
                const totalRows = sheetContainer.children.length / 3;
                if (parseInt(this.dataset.row) === totalRows - 1) {
                    addEmptyRow(totalRows);
                }
            }
        });

        newDiv.appendChild(newTextarea);
        sheetContainer.appendChild(newDiv);

        if (c === 0) newTextarea.focus();
    }
}

// Attach handlers to existing textareas
document.querySelectorAll(".sheet-cell textarea").forEach(textarea => {
    if (!textarea.hasAttribute("readonly")) {
        textarea.addEventListener("keydown", function(e) {
            if (e.key === "Enter") {
                e.preventDefault();
                saveCell(this);
                const sheetContainer = document.querySelector(".sheet-container");
                const totalRows = sheetContainer.children.length / 3;
                if (parseInt(this.dataset.row) === totalRows - 1) {
                    addEmptyRow(totalRows);
                }
            }
        });
        textarea.addEventListener("blur", function() { saveCell(this); });
        textarea.addEventListener("input", function() { autoGrow(this); });
        autoGrow(textarea); // Adjust height on load
    }
});
</script>

</body>
</html>
